name: Pipeline 02 - SAST Scan

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  sast-scan:
    name: SAST Scan with Semgrep
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3️⃣ Install Semgrep
      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep

      # 4️⃣ Create report directories
      - name: Prepare report folders
        run: |
          mkdir -p sast-reports

      # 5️⃣ Pipeline 01: Syntax check (always green)
      - name: Syntax check
        run: |
          python -m py_compile safe_app.py vulnerable_app.py || true
          echo "Syntax check completed. Always green." > sast-reports/syntax-report.txt

      # 6️⃣ Pipeline 02: Run Semgrep SAST Scan
      - name: Run Semgrep SAST scan
        run: |
          semgrep --config semgrep-rules/ \
                  --json > sast-reports/semgrep-report.json
          semgrep --config semgrep-rules/ \
                  --text > sast-reports/semgrep-report.txt

      # 7️⃣ Interpret TXT report for CRITICAL vulnerabilities
      - name: Interpret Semgrep TXT (critical-only, English)
        run: |
          python3 scripts/interpret_sast_txt_critical.py || true

      # 8️⃣ Optional: upload reports as artifacts
      - name: Upload SAST reports
        uses: actions/upload-artifact@v3
        with:
          name: SAST Reports
          path: |
            sast-reports/semgrep-report.json
            sast-reports/semgrep-report.txt
            sast-reports/syntax-report.txt
