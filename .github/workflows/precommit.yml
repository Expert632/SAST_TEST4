name: DevSecOps Lab - Trivy Scan & Auto-Remediation

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  trivy-lab:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Build Docker image
      - name: Build Docker image
        run: |
          docker build -t trivy-lab-image:latest .

      # 3Ô∏è‚É£ Installer Trivy
      - name: Install Trivy
        run: |
          wget -q https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.43.1_Linux-64bit.deb -O /tmp/trivy.deb
          sudo dpkg -i /tmp/trivy.deb
          trivy --version

      # 4Ô∏è‚É£ Trivy scan CRITICAL
      - name: Run Trivy scan (CRITICAL)
        run: |
          trivy image --severity CRITICAL --format json -o trivy-report.json trivy-lab-image:latest || true

      # 5Ô∏è‚É£ Affichage de toutes les vuln√©rabilit√©s CRITICAL
      - name: Show all CRITICAL vulnerabilities
        run: |
          python3 - <<'PY'
import json

with open("trivy-report.json") as f:
    data = json.load(f)

critical_vulns = []

for result in data.get("Results", []):
    vulns = result.get("Vulnerabilities", []) if result.get("Vulnerabilities") else []
    for v in vulns:
        if v.get("Severity", "").upper() == "CRITICAL":
            critical_vulns.append(v)
            print(f"ID: {v['VulnerabilityID']}")
            print(f"Package: {v['PkgName']}:{v['InstalledVersion']}")
            print(f"Severity: {v['Severity']}")
            print(f"Title: {v.get('Title','')}")
            print(f"URL: {v.get('PrimaryURL','')}")
            print("-" * 40)

if not critical_vulns:
    print("‚úÖ Aucune vuln√©rabilit√© CRITICAL d√©tect√©e.")
else:
    print(f"Total CRITICAL vulnerabilities: {len(critical_vulns)}")
PY

      # 6Ô∏è‚É£ Remediation automatique simul√©e
      - name: Auto-Remediation of CRITICAL vulnerabilities
        run: |
          python3 - <<'PY'
import json

with open("trivy-report.json") as f:
    data = json.load(f)

critical_vulns = []

# Collecte toutes les vuln√©rabilit√©s CRITICAL
for result in data.get("Results", []):
    vulns = result.get("Vulnerabilities", []) if result.get("Vulnerabilities") else []
    for v in vulns:
        if v.get("Severity", "").upper() == "CRITICAL":
            critical_vulns.append(v)

if not critical_vulns:
    print("‚úÖ Aucune vuln√©rabilit√© CRITICAL √† rem√©dier.")
else:
    print("üö® D√©but de la rem√©diation automatique simul√©e")
    for v in critical_vulns:
        package = v['PkgName']
        version = v['InstalledVersion']
        vuln_id = v['VulnerabilityID']

        # Simulation de remediation
        remediation = f"Update {package} from {version} to latest patched version"
        success = True  # pour le lab, on simule succ√®s

        print(f"Vuln√©rabilit√©: {vuln_id}")
        print(f"Package: {package}:{version}")
        print(f"Remediation appliqu√©e: {remediation}")
        print(f"R√©sultat: {'‚úÖ Succ√®s' if success else '‚ùå √âchec'}")
        print("-"*40)

    print(f"R√©sum√©: {len(critical_vulns)} vuln√©rabilit√©s CRITICAL d√©tect√©es et rem√©di√©es.")
    # √âchec du job pour simuler la gate si vuln√©rabilit√©s d√©tect√©es
    raise SystemExit("‚ùå Pipeline √©chou√© : Vuln√©rabilit√©s CRITICAL d√©tect√©es !")
PY
